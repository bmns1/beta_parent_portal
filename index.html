<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVA Admin Portal</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/phosphor-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .sidebar-link.active {
            background-color: #f0fdfa; /* teal-50 */
            color: #0d9488; /* teal-600 */
            font-weight: 600;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            margin: 10% auto;
            width: 90%;
            max-width: 600px;
        }
        .modal.flex { display: flex; }
        .tab-content { display: none; }
        .tab-content-active { display: block; }
        .family-row { cursor: pointer; }
        
        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-slate-100 p-4">
        <div class="text-center p-8 bg-white rounded-xl shadow-lg max-w-sm w-full">
            <img src="https://raw.githubusercontent.com/bmns1/parent-portal/main/logo.png" alt="SVA Logo" class="h-20 w-auto mx-auto mb-4">
            <h1 class="text-2xl font-bold text-slate-900">SVA Admin Portal</h1>
            <p class="text-slate-600 mb-6">Please sign in with an authorized admin account.</p>
            <div id="google-signin-button-container" class="flex justify-center"></div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-slate-100 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <i class="ph-spinner-gap text-6xl text-teal-600 mx-auto animate-spin"></i>
            <h2 class="text-2xl font-semibold text-slate-700 mt-4">Loading Admin Data...</h2>
        </div>
    </div>

    <!-- Main Admin Portal -->
    <div id="portal-container" class="hidden">
        <div class="flex h-screen bg-slate-100">
            <!-- Sidebar -->
            <div class="hidden md:flex flex-col w-64 bg-white border-r border-slate-200">
                <div class="flex items-center justify-center h-20 border-b border-slate-200">
                    <img src="https://raw.githubusercontent.com/bmns1/parent-portal/main/logo.png" alt="SVA Logo" class="h-12 w-auto">
                    <span class="ml-3 font-semibold text-xl text-slate-800">Admin Portal</span>
                </div>
                <div class="flex-grow overflow-y-auto">
                    <nav id="sidebar-nav" class="mt-6 px-4 space-y-2">
                        <a href="#" class="sidebar-link active flex items-center py-3 px-4 rounded-lg text-slate-700 hover:bg-slate-100 transition duration-200" data-tab="dashboard">
                            <i class="ph-gauge-fill mr-3 text-lg"></i> Dashboard
                        </a>
                        <a href="#" class="sidebar-link flex items-center py-3 px-4 rounded-lg text-slate-700 hover:bg-slate-100 transition duration-200" data-tab="events">
                            <i class="ph-calendar-fill mr-3 text-lg"></i> Events
                        </a>
                        <a href="#" class="sidebar-link flex items-center py-3 px-4 rounded-lg text-slate-700 hover:bg-slate-100 transition duration-200" data-tab="volunteering">
                            <i class="ph-hands-clapping-fill mr-3 text-lg"></i> Volunteering
                        </a>
                        <a href="#" class="sidebar-link flex items-center py-3 px-4 rounded-lg text-slate-700 hover:bg-slate-100 transition duration-200" data-tab="signups-admin">
                            <i class="ph-user-list-fill mr-3 text-lg"></i> Signed Up Families
                        </a>
                         <a href="#" class="sidebar-link flex items-center py-3 px-4 rounded-lg text-slate-700 hover:bg-slate-100 transition duration-200" data-tab="event-status">
                            <i class="ph-chart-bar-fill mr-3 text-lg"></i> Event Status
                        </a>
                        <a href="#" class="sidebar-link flex items-center py-3 px-4 rounded-lg text-slate-700 hover:bg-slate-100 transition duration-200" data-tab="expenses">
                            <i class="ph-receipt-fill mr-3 text-lg"></i> PTO Expenses
                        </a>
                        <a href="#" class="sidebar-link flex items-center py-3 px-4 rounded-lg text-slate-700 hover:bg-slate-100 transition duration-200" data-tab="progress">
                            <i class="ph-chart-line-up-fill mr-3 text-lg"></i> Family Progress
                        </a>
                    </nav>
                </div>
                <div id="user-info-sidebar" class="p-4 border-t border-slate-200"></div>
            </div>

            <!-- Mobile Sidebar -->
            <div id="mobile-sidebar" class="fixed inset-0 flex z-40 md:hidden transform -translate-x-full transition-transform duration-300 ease-in-out">
                <div class="w-64 bg-white text-slate-700 flex-shrink-0 border-r border-slate-200">
                    <div class="flex items-center justify-between h-20 border-b border-slate-200 px-6">
                        <div class="flex items-center">
                            <img src="https://raw.githubusercontent.com/bmns1/parent-portal/main/logo.png" alt="SVA Logo" class="h-12 w-auto">
                            <span class="ml-3 font-semibold text-xl text-slate-800">Admin</span>
                        </div>
                        <button id="mobile-close-button" class="text-slate-500 hover:text-slate-800">
                            <i class="ph-x text-2xl"></i>
                        </button>
                    </div>
                    <div class="flex-grow">
                        <nav id="mobile-sidebar-nav" class="mt-6 px-4 space-y-2">
                           <!-- Mobile links will be injected here by JS -->
                        </nav>
                    </div>
                </div>
                <div id="mobile-sidebar-overlay" class="flex-1 bg-black opacity-50"></div>
            </div>

            <!-- Main Content -->
            <div class="flex flex-col flex-1 overflow-y-auto">
                <div class="flex items-center justify-between h-20 bg-white border-b border-slate-200 px-6 sticky top-0 z-30">
                     <button id="mobile-menu-button" class="md:hidden text-slate-500 hover:text-slate-600 focus:outline-none focus:text-slate-600">
                        <i class="ph-list text-2xl"></i>
                    </button>
                    <h1 id="page-title" class="text-2xl font-semibold text-slate-900">Dashboard</h1>
                    <button onclick="signOut();" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition duration-300">Sign Out</button>
                </div>
                
                <main class="p-6 sm:p-10 space-y-6">
                    <div id="dashboard" class="tab-content tab-content-active"></div>
                    <div id="events" class="tab-content"></div>
                    <div id="volunteering" class="tab-content"></div>
                    <div id="signups-admin" class="tab-content"></div>
                    <div id="event-status" class="tab-content"></div>
                    <div id="expenses" class="tab-content"></div>
                    <div id="progress" class="tab-content"></div>
                </main>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <!-- Create Event -->
    <div id="event-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl">
            <h2 class="text-xl font-semibold mb-4">Create New Event</h2>
            <form id="event-form" class="space-y-4">
                <div>
                    <label for="event-id" class="block text-sm font-medium text-slate-700">Event ID (e.g., E101)</label>
                    <input type="text" id="event-id" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" required>
                </div>
                <div>
                    <label for="event-name" class="block text-sm font-medium text-slate-700">Event Name</label>
                    <input type="text" id="event-name" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" required>
                </div>
                <div>
                    <label for="event-date" class="block text-sm font-medium text-slate-700">Event Date</label>
                    <input type="date" id="event-date" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" required>
                </div>
                <div>
                    <label for="event-grade" class="block text-sm font-medium text-slate-700">Grade (Optional - e.g., K, 1, 5)</label>
                    <input type="text" id="event-grade" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                </div>
                <div>
                    <label for="event-classroom" class="block text-sm font-medium text-slate-700">Classroom (Optional - e.g., A)</label>
                    <input type="text" id="event-classroom" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" onclick="closeModal('event-modal')" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">Cancel</button>
                    <button type="submit" id="save-event-btn" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700">Save Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Update Status -->
    <div id="status-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl">
            <h2 class="text-xl font-semibold mb-4">Update Status</h2>
            <p class="text-sm text-slate-600 mb-6">Select a new status for this signup. This will update the record immediately.</p>
            <input type="hidden" id="status-modal-signupid">
            <div class="space-y-3">
                <button id="status-btn-completed" class="w-full text-left bg-green-100 text-green-800 font-semibold py-3 px-4 rounded-lg hover:bg-green-200 transition">Mark as Completed</button>
                <button id="status-btn-inprogress" class="w-full text-left bg-slate-100 text-slate-800 font-semibold py-3 px-4 rounded-lg hover:bg-slate-200 transition">Mark as In Progress</button>
                <button id="status-btn-penalty" class="w-full text-left bg-red-100 text-red-800 font-semibold py-3 px-4 rounded-lg hover:bg-red-200 transition">Mark as Penalty</button>
            </div>
            <div class="mt-6 text-right">
                <button type="button" onclick="closeModal('status-modal')" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Family Details -->
    <div id="family-details-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900" id="fd-family-id">Family Details</h2>
                    <p class="text-slate-500 text-sm mt-1" id="fd-student-names">Students: --</p>
                </div>
                <button onclick="closeModal('family-details-modal')" class="text-slate-400 hover:text-slate-600 transition">
                    <i class="ph-x text-2xl"></i>
                </button>
            </div>
            <div id="fd-content" class="space-y-6 overflow-y-auto max-h-[70vh] pr-2"></div>
            <div class="mt-6 text-right pt-4 border-t border-slate-100">
                <button type="button" onclick="closeModal('family-details-modal')" class="bg-slate-200 text-slate-800 font-semibold py-2 px-6 rounded-lg hover:bg-slate-300 transition">Close</button>
            </div>
        </div>
    </div>


    <script>
        const ADMIN_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyXR747DT2sH_K-rvtoKEObWo5OYUpgUhBMWG7zwm4B3uliAGLZ1Jq0bZ2onc_U-8g/exec';
        const PARENT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx3LGShhqFBG5Y2TocWHYYgg8Sp-mK2YbkZ2x6tWJwf6li0teEvIYYXa5zNxDKtV4U7/exec';
        const CLIENT_ID = "14216824305-v19ecsmrhk1muaglrlhjceqjk5oeqr4n.apps.googleusercontent.com";
        let ID_TOKEN = null;
        let adminData = {};

        // --- GOOGLE SIGN-IN ---
        function handleCredentialResponse(response) {
            ID_TOKEN = response.credential;
            const profile = JSON.parse(atob(ID_TOKEN.split('.')[1]));
            
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('loading-overlay').classList.remove('hidden');

            const userInfoHtml = `<div class="flex items-center"><img class="h-8 w-8 rounded-full" src="${profile.picture}" alt=""><div class="ml-3"><div class="text-sm font-medium text-slate-800">${profile.name}</div><div class="text-xs text-slate-500">${profile.email}</div></div></div>`;
            document.getElementById('user-info-sidebar').innerHTML = userInfoHtml;

            fetchAdminData(ID_TOKEN);
        }

        function signOut() {
            google.accounts.id.disableAutoSelect();
            window.location.reload();
        }
        
        function openModal(modalId) { document.getElementById(modalId).classList.add('flex'); }
        function closeModal(modalId) { document.getElementById(modalId).classList.remove('flex'); }

        // --- DATA FETCH & RENDER ---
        function fetchAdminData(token) {
            document.getElementById('loading-overlay').classList.remove('hidden');
            fetch(`${ADMIN_WEB_APP_URL}?token=${token}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status !== 'success' || !data.data || !data.data.isAdmin) {
                        throw new Error(data.error || "Access Denied. This account is not authorized for the admin portal.");
                    }
                    adminData = data.data;
                    document.getElementById('loading-overlay').classList.add('hidden');
                    document.getElementById('portal-container').classList.remove('hidden');
                    renderAllTabs();
                    addEventListeners();
                })
                .catch(error => {
                    console.error('Admin Fetch Error:', error);
                    document.getElementById('loading-overlay').innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow-lg max-w-sm w-full"><img src="https://raw.githubusercontent.com/bmns1/parent-portal/main/logo.png" alt="SVA Logo" class="h-20 w-auto mx-auto mb-4"><h1 class="text-xl font-bold text-red-600">Access Denied</h1><p class="text-slate-600 mt-2">${error.message}</p><button onclick="window.location.reload();" class="mt-6 bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">Try Again</button></div>`;
                });
        }
        
        function postAdminData(payload, successMessage) {
            return new Promise((resolve, reject) => {
                fetch(ADMIN_WEB_APP_URL, {
                    method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload)
                }).then(() => { 
                    alert(successMessage); fetchAdminData(ID_TOKEN); resolve();
                }).catch(error => { console.error('POST Error:', error); alert(`An error occurred: ${error.message}`); reject(error); });
            });
        }

        function postParentData(payload) {
             return new Promise((resolve, reject) => {
                fetch(PARENT_WEB_APP_URL, { 
                    method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload)
                }).then(() => { resolve(); }).catch(error => { console.error('Parent App POST Error:', error); reject(error); });
            });
        }

        function renderAllTabs() {
            renderDashboard();
            renderEventsTab();
            renderVolunteeringTab();
            renderSignupsTab();
            renderEventStatusTab();
            renderExpensesTab();
            renderFamilyProgressTab();
            renderMobileMenu();
        }

        function renderDashboard() {
            const container = document.getElementById('dashboard');
            const s1Completed = Object.values(adminData.familyProgress).reduce((sum, family) => sum + family.progress.semester1.completed, 0);
            const s1InProgress = Object.values(adminData.familyProgress).reduce((sum, family) => sum + family.progress.semester1.inProgress, 0);
            const s1Vacant = adminData.volunteering.filter(o => o.semester == 1).reduce((sum, opp) => sum + ((parseFloat(opp.neededvolunteers) || 0) - (parseFloat(opp.signedupvolunteers) || 0)) * (parseFloat(opp['number of hours']) || 0), 0);
            const s1TotalRequired = Object.values(adminData.familyProgress).reduce((sum, family) => sum + family.progress.semester1.baseRequired, 0);
            
            const s2Completed = Object.values(adminData.familyProgress).reduce((sum, family) => sum + family.progress.semester2.completed, 0);
            const s2InProgress = Object.values(adminData.familyProgress).reduce((sum, family) => sum + family.progress.semester2.inProgress, 0);
            const s2Vacant = adminData.volunteering.filter(o => o.semester == 2).reduce((sum, opp) => sum + ((parseFloat(opp.neededvolunteers) || 0) - (parseFloat(opp.signedupvolunteers) || 0)) * (parseFloat(opp['number of hours']) || 0), 0);
            const s2TotalRequired = Object.values(adminData.familyProgress).reduce((sum, family) => sum + family.progress.semester2.baseRequired, 0);

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><h3 class="text-slate-500 text-sm font-medium">S1 Completed Hours</h3><p class="text-3xl font-bold text-slate-900 mt-2">${s1Completed}</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><h3 class="text-slate-500 text-sm font-medium">S1 In-Progress Hours</h3><p class="text-3xl font-bold text-slate-900 mt-2">${s1InProgress}</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><h3 class="text-slate-500 text-sm font-medium">S1 Vacant Hours</h3><p class="text-3xl font-bold text-slate-900 mt-2">${s1Vacant}</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><h3 class="text-slate-500 text-sm font-medium">S2 Completed Hours</h3><p class="text-3xl font-bold text-slate-900 mt-2">${s2Completed}</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><h3 class="text-slate-500 text-sm font-medium">S2 In-Progress Hours</h3><p class="text-3xl font-bold text-slate-900 mt-2">${s2InProgress}</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><h3 class="text-slate-500 text-sm font-medium">S2 Vacant Hours</h3><p class="text-3xl font-bold text-slate-900 mt-2">${s2Vacant}</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="text-xl font-semibold mb-4 text-slate-900">Volunteer Hours Overview</h3>
                        <canvas id="hoursChart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="text-xl font-semibold mb-4 text-slate-900">Families with Hours Remaining</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="hours-slider-s1" class="block text-sm font-medium text-slate-700">Semester 1: More than <span id="slider-value-s1" class="font-bold text-teal-600">8</span> hrs remaining</label>
                                <input id="hours-slider-s1" type="range" min="0" max="20" value="8" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer mt-2">
                                <p class="text-center text-4xl font-bold text-slate-800 mt-2" id="families-remaining-count-s1">--</p>
                            </div>
                            <div>
                                <label for="hours-slider-s2" class="block text-sm font-medium text-slate-700">Semester 2: More than <span id="slider-value-s2" class="font-bold text-teal-600">8</span> hrs remaining</label>
                                <input id="hours-slider-s2" type="range" min="0" max="20" value="8" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer mt-2">
                                <p class="text-center text-4xl font-bold text-slate-800 mt-2" id="families-remaining-count-s2">--</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const ctx = document.getElementById('hoursChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Semester 1', 'Semester 2'],
                    datasets: [
                        { label: 'Completed', data: [s1Completed, s2Completed], backgroundColor: '#0d9488' },
                        { label: 'In Progress', data: [s1InProgress, s2InProgress], backgroundColor: '#f59e0b' },
                        { label: 'Vacant', data: [s1Vacant, s2Vacant], backgroundColor: '#ef4444' },
                        {
                            label: 'Total Required',
                            data: [s1TotalRequired, s2TotalRequired],
                            type: 'line',
                            borderColor: '#475569',
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: { scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
            });
            updateRemainingFamiliesCount();
        }
        
        function updateRemainingFamiliesCount() {
            const slider1 = document.getElementById('hours-slider-s1');
            const value1 = document.getElementById('slider-value-s1');
            const count1 = document.getElementById('families-remaining-count-s1');
            const slider2 = document.getElementById('hours-slider-s2');
            const value2 = document.getElementById('slider-value-s2');
            const count2 = document.getElementById('families-remaining-count-s2');

            if (!slider1 || !slider2) return;

            const hours1 = parseInt(slider1.value);
            value1.textContent = hours1;
            const countS1 = Object.values(adminData.familyProgress).filter(f => (f.progress.semester1.totalRequired - f.progress.semester1.completed) > hours1).length;
            count1.textContent = countS1;

            const hours2 = parseInt(slider2.value);
            value2.textContent = hours2;
            const countS2 = Object.values(adminData.familyProgress).filter(f => (f.progress.semester2.totalRequired - f.progress.semester2.completed) > hours2).length;
            count2.textContent = countS2;
        }

        function renderEventsTab() {
            const container = document.getElementById('events');
            const tableRows = adminData.events.map(event => `
                <tr class="border-b border-slate-200 hover:bg-slate-50">
                    <td class="py-3 px-4">${event.eventname}</td>
                    <td class="py-3 px-4">${new Date(event.eventdate).toLocaleDateString()}</td>
                    <td class="py-3 px-4">${event.grade || 'All'}</td>
                    <td class="py-3 px-4">${event.classroom || 'All'}</td>
                    <td class="py-3 px-4 font-mono text-xs">${event.eventid}</td>
                    <td class="py-3 px-4 text-right">
                        <button class="text-blue-600 hover:underline font-medium mr-4">Edit</button>
                        <button class="text-red-600 hover:underline font-medium">Delete</button>
                    </td>
                </tr>
            `).join('');

            container.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4">
                    <h2 class="text-2xl font-semibold text-slate-900">Manage Events</h2>
                    <button id="create-event-btn" class="w-full sm:w-auto mt-4 sm:mt-0 bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors">Create Event</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-700">
                        <thead class="bg-slate-50 text-xs text-slate-500 uppercase"><tr>
                            <th class="py-3 px-4">Name</th><th class="py-3 px-4">Date</th><th class="py-3 px-4">Grade</th><th class="py-3 px-4">Class</th><th class="py-3 px-4">ID</th><th class="py-3 px-4"></th>
                        </tr></thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                </div>
            </div>`;
        }

        function renderVolunteeringTab() {
            const container = document.getElementById('volunteering');
            const eventOptions = adminData.events.map(event => `<option value="${event.eventid}">${event.eventname}</option>`).join('');

            container.innerHTML = `<div class="space-y-6">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                    <h2 class="text-2xl font-semibold text-slate-900">Manage Volunteering</h2>
                    <div class="flex flex-col sm:flex-row gap-4 w-full sm:w-auto mt-4 sm:mt-0">
                        <select id="volunteering-event-filter" class="w-full sm:w-auto rounded-md border-slate-300 shadow-sm">
                            <option value="all">All Events</option>
                            ${eventOptions}
                        </select>
                        <button class="w-full sm:w-auto bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors">Create Opportunity</button>
                    </div>
                </div>
                <div id="volunteering-cards-list" class="space-y-4"></div>
            </div>`;
            
            applyVolunteerFilters(); 
        }
        
        function applyVolunteerFilters() {
            const filterValue = document.getElementById('volunteering-event-filter').value;
            let opportunities = [...adminData.volunteering];
            opportunities.sort((a, b) => new Date(a.date) - new Date(b.date));
            if (filterValue !== 'all') {
                opportunities = opportunities.filter(opp => opp.eventid === filterValue);
            }
            renderVolunteerCards(opportunities);
        }

        function renderVolunteerCards(opportunities) {
            const container = document.getElementById('volunteering-cards-list');
            if (opportunities.length === 0) {
                container.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 text-center text-slate-500">No volunteering opportunities found for this event.</div>`;
                return;
            }
            container.innerHTML = opportunities.map(opp => `
                <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div class="mb-4 sm:mb-0">
                        <h3 class="font-semibold text-lg text-slate-900">${opp.title}</h3>
                        <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-slate-500 mt-1">
                            <span><i class="ph-calendar-blank mr-1"></i>${new Date(opp.date).toLocaleDateString()}</span>
                            <span><i class="ph-clock mr-1"></i>${opp.time}</span>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                        <div class="text-sm sm:text-right">
                            <span class="font-bold text-xl text-teal-600">${opp.signedupvolunteers}</span>
                            <span class="text-slate-500">/ ${opp.neededvolunteers} Spots Filled</span>
                        </div>
                        <div class="flex-shrink-0 flex gap-2">
                            <button class="text-blue-600 hover:underline font-medium">Edit</button>
                            <button class="text-red-600 hover:underline font-medium">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderSignupsTab() {
            const container = document.getElementById('signups-admin');
            if (!adminData.events || !adminData.signups || !adminData.familyDetails || !adminData.volunteering) {
                container.innerHTML = '<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><p>No signup data available to display.</p></div>';
                return;
            }
            const oppToEventMap = adminData.volunteering.reduce((map, opp) => {
                if (opp.opportunityid) { map[String(opp.opportunityid).trim()] = String(opp.eventid).trim(); }
                return map;
            }, {});
            const signupsByEvent = adminData.signups.reduce((acc, signup) => {
                const oppId = String(signup.opportunityid).trim();
                const eventId = oppToEventMap[oppId] || 'general';
                if (!acc[eventId]) acc[eventId] = [];
                acc[eventId].push(signup);
                return acc;
            }, {});
            const eventNameMap = adminData.events.reduce((map, event) => {
                map[String(event.eventid).trim()] = event.eventname;
                return map;
            }, {});
            const volunteeringMap = adminData.volunteering.reduce((map, opp) => {
                if (opp.opportunityid) { map[String(opp.opportunityid).trim()] = opp; }
                return map;
            }, {});
            const eventCardsHtml = Object.keys(signupsByEvent).map((eventId, index) => {
                const eventSignups = signupsByEvent[eventId];
                const eventName = eventNameMap[eventId] || 'General Opportunities';
                const opportunitiesInEvent = eventSignups.reduce((acc, signup) => {
                    const oppId = String(signup.opportunityid).trim();
                    if (oppId) { if (!acc[oppId]) acc[oppId] = []; acc[oppId].push(signup); }
                    return acc;
                }, {});
                const opportunityCardsHtml = Object.entries(opportunitiesInEvent).map(([oppId, signups]) => {
                    const oppDetails = volunteeringMap[oppId] || {};
                    const familyListHtml = signups.map(s => {
                        const familyDetails = adminData.familyDetails[s.familyid] || { students: ['N/A'] };
                        const studentNames = familyDetails.students.join(', ');
                        const statusColor = s.status === 'Completed' ? 'text-green-700 bg-green-100' : s.status === 'Penalty' ? 'text-red-700 bg-red-100' : 'text-slate-700 bg-slate-100';
                        
                        return `<div class="border-t border-slate-100 mt-2 pt-2"><div class="flex justify-between items-center"><div><p class="font-semibold text-sm text-slate-800">${s.parentemail}</p><p class="text-xs text-slate-500">Family ID: ${s.familyid} | Students: ${studentNames}</p></div>
                            <button 
                                class="status-btn inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${statusColor} cursor-pointer hover:opacity-80 transition-opacity"
                                data-signup-id="${s.signupid}"
                                data-current-status="${s.status}">
                                ${s.status}
                            </button>
                        </div></div>`;
                        
                    }).join('');
                    return `<div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200"><h5 class="font-bold text-slate-800">${oppDetails.title || 'Unknown Task'} (${oppDetails.time || 'N/A'})</h5><p class="text-sm text-slate-500 mt-1">${oppDetails.description || ''}</p><div class="mt-2"><h6 class="text-xs font-semibold text-slate-600 uppercase">Signed-up Families:</h6><div class="space-y-2">${familyListHtml}</div></div></div>`;
                }).join('');
                return `<div class="bg-slate-50 rounded-lg shadow-sm border border-slate-200 overflow-hidden"><div class="p-4 border-b border-slate-200 cursor-pointer flex justify-between items-center event-card-header" data-target="opportunity-group-${index}"><h3 class="text-xl font-bold text-slate-900">${eventName}</h3><i class="ph-caret-down text-2xl transition-transform"></i></div><div id="opportunity-group-${index}" class="hidden p-4 space-y-4 bg-slate-50">${opportunityCardsHtml}</div></div>`;
            }).join('');
            container.innerHTML = `<div class="space-y-4">${eventCardsHtml || '<p>No families have signed up for any events yet.</p>'}</div>`;
        }

        function renderEventStatusTab() {
            const container = document.getElementById('event-status');
             const eventOptions = adminData.events.map(event => `<option value="${event.eventid}">${event.eventname}</option>`).join('');

            container.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4">
                    <h2 class="text-2xl font-semibold text-slate-900">Event Signup Status</h2>
                    <select id="event-status-filter" class="w-full sm:w-1/3 mt-4 sm:mt-0 rounded-md border-slate-300 shadow-sm">
                        <option value="all">Select an Event</option>
                        ${eventOptions}
                    </select>
                </div>
                <div id="event-status-display">
                    <p class="text-slate-500">Select an event from the dropdown to see its status.</p>
                </div>
            </div>`;
        }

        function renderExpensesTab() {
            const container = document.getElementById('expenses');
            const tableRows = adminData.expenses.map(exp => `
                <tr class="border-b border-slate-200 hover:bg-slate-50">
                    <td class="py-3 px-4">${new Date(exp.date).toLocaleDateString()}</td>
                    <td class="py-3 px-4">${exp.submittedby}</td>
                    <td class="py-3 px-4">${exp.item}</td>
                    <td class="py-3 px-4">$${parseFloat(exp.amount).toFixed(2)}</td>
                    <td class="py-3 px-4">${exp.status}</td>
                </tr>
            `).join('');

            container.innerHTML = `<div class="grid md:grid-cols-3 gap-6">
                <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-2xl font-semibold mb-4 text-slate-900">Expense History</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-700">
                            <thead class="bg-slate-50 text-xs text-slate-500 uppercase"><tr>
                                <th class="py-3 px-4">Date</th><th class="py-3 px-4">Submitted By</th><th class="py-3 px-4">Item</th><th class="py-3 px-4">Amount</th><th class="py-3 px-4">Status</th>
                            </tr></thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-2xl font-semibold mb-4 text-slate-900">Report New Expense</h2>
                    <form id="expense-form" class="space-y-4">
                        <div><label class="block text-sm font-medium">Item</label><input type="text" id="expense-item" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" required></div>
                        <div><label class="block text-sm font-medium">Description</label><textarea id="expense-desc" rows="3" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm"></textarea></div>
                        <div><label class="block text-sm font-medium">Category</label><input type="text" id="expense-cat" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm"></div>
                        <div><label class="block text-sm font-medium">Amount</label><input type="number" step="0.01" id="expense-amount" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" required></div>
                        <button type="submit" class="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700">Submit Expense</button>
                    </form>
                </div>
            </div>`;
        }
        
        function renderFamilyProgressTab() {
            const container = document.getElementById('progress');
            
            // Layout with filters and buttons
            container.innerHTML = `
            <div id="printable-area" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 no-print">
                    <h2 class="text-2xl font-semibold text-slate-900">Family Progress</h2>
                    <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                        <select id="progress-filter" class="rounded-md border-slate-300 shadow-sm text-sm focus:border-teal-500 focus:ring-teal-500">
                            <option value="all">All Families</option>
                            <option value="incomplete-s1">Incomplete Semester 1</option>
                            <option value="incomplete-s2">Incomplete Semester 2</option>
                        </select>
                        <input type="text" id="family-search" placeholder="Search Family ID..." class="rounded-md border-slate-300 shadow-sm text-sm">
                        <button id="download-csv-btn" class="bg-slate-100 text-slate-700 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-200 flex items-center justify-center">
                            <i class="ph-download-simple mr-2"></i> CSV
                        </button>
                        <button id="print-progress-btn" class="bg-teal-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-teal-700 flex items-center justify-center">
                            <i class="ph-printer mr-2"></i> Print
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-700">
                        <thead class="bg-slate-50 text-xs text-slate-500 uppercase">
                            <tr>
                                <th rowspan="2" class="py-3 px-4 align-bottom">Family ID / Students</th>
                                <th colspan="4" class="py-3 px-4 text-center border-b border-l border-slate-200">Semester 1</th>
                                <th colspan="4" class="py-3 px-4 text-center border-b border-l border-slate-200">Semester 2</th>
                            </tr>
                            <tr>
                                <th class="py-2 px-4 text-center font-normal border-l border-slate-200">Completed</th>
                                <th class="py-2 px-4 text-center font-normal">In Progress</th>
                                <th class="py-2 px-4 text-center font-normal">Penalty</th>
                                <th class="py-2 px-4 text-center font-normal">Total Req.</th>
                                <th class="py-2 px-4 text-center font-normal border-l border-slate-200">Completed</th>
                                <th class="py-2 px-4 text-center font-normal">In Progress</th>
                                <th class="py-2 px-4 text-center font-normal">Penalty</th>
                                <th class="py-2 px-4 text-center font-normal">Total Req.</th>
                            </tr>
                        </thead>
                        <tbody id="family-progress-tbody">
                            <!-- Rows injected by updateFamilyProgressTable -->
                        </tbody>
                    </table>
                </div>
            </div>`;
            
            // Initial load of the rows
            updateFamilyProgressTable();
        }

        // --- NEW Helper: Filter & Update Rows ---
        function updateFamilyProgressTable() {
            const tbody = document.getElementById('family-progress-tbody');
            if (!tbody) return;

            const filter = document.getElementById('progress-filter') ? document.getElementById('progress-filter').value : 'all';
            const searchTerm = document.getElementById('family-search') ? document.getElementById('family-search').value.toLowerCase().trim() : '';

            const rowsHtml = Object.entries(adminData.familyProgress).map(([familyId, data]) => {
                // Get student names
                const familyDetails = adminData.familyDetails[familyId] || { students: [] };
                const studentNames = familyDetails.students.length > 0 ? familyDetails.students.join(', ') : 'N/A';
                
                // Filter Logic
                if (searchTerm && !familyId.toLowerCase().includes(searchTerm) && !studentNames.toLowerCase().includes(searchTerm)) {
                    return ''; // Skip if doesn't match search
                }

                if (filter === 'incomplete-s1') {
                    if (data.progress.semester1.completed >= data.progress.semester1.totalRequired) return '';
                } else if (filter === 'incomplete-s2') {
                    if (data.progress.semester2.completed >= data.progress.semester2.totalRequired) return '';
                }

                // Determine background color
                const s1BgClass = (data.progress.semester1.completed >= data.progress.semester1.totalRequired) ? 'bg-green-100 text-green-800 font-semibold' : 'bg-orange-100 text-orange-800 font-semibold';
                const s2BgClass = (data.progress.semester2.completed >= data.progress.semester2.totalRequired) ? 'bg-green-100 text-green-800 font-semibold' : 'bg-orange-100 text-orange-800 font-semibold';

                return `
                <tr class="border-b border-slate-200 family-row hover:bg-slate-50" data-family-id="${familyId}">
                    <td class="py-3 px-4 font-mono">
                        <div>${familyId}</div>
                        <div class="text-xs text-slate-500 mt-1">${studentNames}</div>
                    </td>
                    <td class="py-3 px-4 text-center ${s1BgClass}">${data.progress.semester1.completed}</td>
                    <td class="py-3 px-4 text-center">${data.progress.semester1.inProgress}</td>
                    <td class="py-3 px-4 text-center text-red-600">${data.progress.semester1.penalty}</td>
                    <td class="py-3 px-4 text-center font-semibold">${data.progress.semester1.totalRequired}</td>
                    <td class="py-3 px-4 text-center ${s2BgClass}">${data.progress.semester2.completed}</td>
                    <td class="py-3 px-4 text-center">${data.progress.semester2.inProgress}</td>
                    <td class="py-3 px-4 text-center text-red-600">${data.progress.semester2.penalty}</td>
                    <td class="py-3 px-4 text-center font-semibold">${data.progress.semester2.totalRequired}</td>
                </tr>`;
            }).join('');

            tbody.innerHTML = rowsHtml || '<tr><td colspan="9" class="text-center py-4 text-slate-500">No matching families found.</td></tr>';
        }

        // --- NEW Helper: Download CSV ---
        function downloadFamilyProgressCSV() {
            const filter = document.getElementById('progress-filter').value;
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Family ID,Students,S1 Completed,S1 In Progress,S1 Penalty,S1 Required,S2 Completed,S2 In Progress,S2 Penalty,S2 Required\n";

            Object.entries(adminData.familyProgress).forEach(([familyId, data]) => {
                const familyDetails = adminData.familyDetails[familyId] || { students: [] };
                const studentNames = `"${familyDetails.students.join(', ')}"`; // Quote names for CSV safety

                // Re-apply same filter logic
                if (filter === 'incomplete-s1' && data.progress.semester1.completed >= data.progress.semester1.totalRequired) return;
                if (filter === 'incomplete-s2' && data.progress.semester2.completed >= data.progress.semester2.totalRequired) return;

                const row = [
                    familyId,
                    studentNames,
                    data.progress.semester1.completed,
                    data.progress.semester1.inProgress,
                    data.progress.semester1.penalty,
                    data.progress.semester1.totalRequired,
                    data.progress.semester2.completed,
                    data.progress.semester2.inProgress,
                    data.progress.semester2.penalty,
                    data.progress.semester2.totalRequired
                ].join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `family_progress_${filter}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function renderMobileMenu() {
            const desktopNav = document.getElementById('sidebar-nav');
            const mobileNav = document.getElementById('mobile-sidebar-nav');
            mobileNav.innerHTML = desktopNav.innerHTML;
        }
        
        function showFamilyDetails(familyId) {
            const familyDetails = adminData.familyDetails[familyId];
            if (!familyDetails) return;

            document.getElementById('fd-family-id').textContent = `Family: ${familyId}`;
            document.getElementById('fd-student-names').textContent = `Students: ${familyDetails.students.join(', ')}`;
            
            const familySignups = adminData.signups.filter(s => String(s.familyid) === String(familyId));
            const volunteeringMap = adminData.volunteering.reduce((map, opp) => {
                if (opp.opportunityid) { map[String(opp.opportunityid).trim()] = opp; }
                return map;
            }, {});

            let contentHtml = '';
            const renderSignupList = (signups) => {
                 if (signups.length === 0) return `<p class="text-sm text-slate-500 italic">No activity recorded.</p>`;
                 return `<div class="space-y-3">` + signups.map(s => {
                    const oppId = String(s.opportunityid).trim();
                    const opp = volunteeringMap[oppId] || {};
                    const statusColor = s.status === 'Completed' ? 'text-green-700 bg-green-100' : s.status === 'Penalty' ? 'text-red-700 bg-red-100' : 'text-slate-700 bg-slate-100';
                    const title = opp.title || `Opportunity ID: ${oppId}`;
                    const dateStr = opp.date ? new Date(opp.date).toLocaleDateString() : (s.signupdate ? new Date(s.signupdate).toLocaleDateString() : 'N/A');
                    const hours = opp.hours !== undefined ? opp.hours : '?';
                    return `<div class="flex justify-between items-start border-b border-slate-100 pb-2 last:border-0"><div><p class="font-semibold text-sm text-slate-800">${title}</p><p class="text-xs text-slate-500">${dateStr} | ${hours} Hours</p></div><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${statusColor}">${s.status}</span></div>`;
                 }).join('') + `</div>`;
            };

            contentHtml += `<div class="mb-6"><h3 class="font-bold text-lg text-slate-800 border-b pb-2 mb-3">Semester 1</h3>`;
            contentHtml += renderSignupList(familySignups.filter(s => { const opp = volunteeringMap[String(s.opportunityid).trim()]; return opp && String(opp.semester).trim() === '1'; }));
            contentHtml += `</div><div><h3 class="font-bold text-lg text-slate-800 border-b pb-2 mb-3">Semester 2</h3>`;
            contentHtml += renderSignupList(familySignups.filter(s => { const opp = volunteeringMap[String(s.opportunityid).trim()]; return opp && String(opp.semester).trim() === '2'; }));
            contentHtml += `</div>`;
            
            const otherSignups = familySignups.filter(s => !volunteeringMap[String(s.opportunityid).trim()]);
            if (otherSignups.length > 0) {
                contentHtml += `<div class="mt-6"><h3 class="font-bold text-lg text-slate-800 border-b pb-2 mb-3">Other / Unmatched Activities</h3>${renderSignupList(otherSignups)}</div>`;
            }

            document.getElementById('fd-content').innerHTML = contentHtml;
            openModal('family-details-modal');
        }

        function updateSignupStatus(signupId, newStatus) {
            const payload = { action: 'updateSignupStatus', signupId: signupId, newStatus: newStatus, token: ID_TOKEN };
            return postParentData(payload); 
        }
        
        function addEventListeners() {
            document.body.addEventListener('click', e => {
                const button = e.target.closest('button');
                const sidebarLink = e.target.closest('.sidebar-link');
                const familyRow = e.target.closest('.family-row');

                // --- NEW: Download & Print Buttons ---
                if (button && button.id === 'download-csv-btn') {
                    downloadFamilyProgressCSV();
                    return;
                }
                if (button && button.id === 'print-progress-btn') {
                    window.print();
                    return;
                }

                const header = e.target.closest('.event-card-header');
                if (header) {
                    const targetId = header.dataset.target;
                    const content = document.getElementById(targetId);
                    const icon = header.querySelector('i');
                    if (content) {
                        content.classList.toggle('hidden');
                        icon.classList.toggle('rotate-180');
                    }
                    return;
                }
                
                if (familyRow) {
                    const familyId = familyRow.dataset.familyId;
                    showFamilyDetails(familyId);
                    return;
                }

                if (sidebarLink) {
                    e.preventDefault();
                    document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                    sidebarLink.classList.add('active');
                    const tabId = sidebarLink.dataset.tab;
                    document.getElementById('page-title').textContent = sidebarLink.textContent.trim();
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('tab-content-active'));
                    document.getElementById(tabId).classList.add('tab-content-active');
                    document.getElementById('mobile-sidebar').classList.add('-translate-x-full');
                    return; 
                }

                if (!button) {
                    if (e.target.classList.contains('modal')) { closeModal(e.target.id); }
                    return;
                }
                
                if (button.classList.contains('status-btn')) {
                    const signupId = button.dataset.signupId;
                    document.getElementById('status-modal-signupid').value = signupId;
                    openModal('status-modal');
                    e.stopPropagation(); 
                }

                if (button.id.startsWith('status-btn-')) {
                    const newStatus = button.id.split('-').pop();
                    let formattedStatus = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                    if (newStatus === 'inprogress') formattedStatus = 'In Progress';
                    const signupId = document.getElementById('status-modal-signupid').value;
                    button.disabled = true; button.textContent = 'Updating...';

                    updateSignupStatus(signupId, formattedStatus).then(() => {
                        const originalButton = document.querySelector(`.status-btn[data-signup-id="${signupId}"]`);
                        if (originalButton) {
                            originalButton.textContent = formattedStatus;
                            originalButton.dataset.currentStatus = formattedStatus;
                            const statusColor = formattedStatus === 'Completed' ? 'text-green-700 bg-green-100' : formattedStatus === 'Penalty' ? 'text-red-700 bg-red-100' : 'text-slate-700 bg-slate-100';
                            originalButton.className = `status-btn inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${statusColor} cursor-pointer hover:opacity-80 transition-opacity`;
                        }
                        const signupInAdminData = adminData.signups.find(s => s.signupid == signupId);
                        if (signupInAdminData) { signupInAdminData.status = formattedStatus; }
                    }).catch(() => { alert("An error occurred. The status was not updated."); })
                    .finally(() => {
                        document.getElementById('status-btn-completed').disabled = false; document.getElementById('status-btn-completed').textContent = 'Mark as Completed';
                        document.getElementById('status-btn-inprogress').disabled = false; document.getElementById('status-btn-inprogress').textContent = 'Mark as In Progress';
                        document.getElementById('status-btn-penalty').disabled = false; document.getElementById('status-btn-penalty').textContent = 'Mark as Penalty';
                        closeModal('status-modal');
                    });
                }

                if (button.id === 'create-event-btn') { openModal('event-modal'); }
                if (button.id === 'mobile-menu-button') { document.getElementById('mobile-sidebar').classList.remove('-translate-x-full'); }
                if (button.id === 'mobile-close-button' || e.target.id === 'mobile-sidebar-overlay') { document.getElementById('mobile-sidebar').classList.add('-translate-x-full'); }
            });

            document.getElementById('event-form').addEventListener('submit', e => {
                e.preventDefault();
                const button = document.getElementById('save-event-btn');
                button.textContent = 'Saving...'; button.disabled = true;
                const eventData = { eventid: document.getElementById('event-id').value, eventname: document.getElementById('event-name').value, eventdate: document.getElementById('event-date').value, grade: document.getElementById('event-grade').value, classroom: document.getElementById('event-classroom').value };
                postAdminData({ action: 'addEvent', data: eventData, token: ID_TOKEN }, 'Event created successfully!').then(() => { closeModal('event-modal'); document.getElementById('event-form').reset(); }).finally(() => { button.textContent = 'Save Event'; button.disabled = false; });
            });

            document.getElementById('expense-form').addEventListener('submit', e => {
                e.preventDefault();
                const button = e.target.querySelector('button[type="submit"]');
                button.textContent = 'Submitting...'; button.disabled = true;
                const expenseData = { item: document.getElementById('expense-item').value, description: document.getElementById('expense-desc').value, category: document.getElementById('expense-cat').value, amount: document.getElementById('expense-amount').value };
                postAdminData({ action: 'addExpense', data: expenseData, token: ID_TOKEN }, 'Expense submitted!').then(() => document.getElementById('expense-form').reset()).finally(() => { button.textContent = 'Submit Expense'; button.disabled = false; });
            });
            
            // --- NEW LISTENERS for Progress Tab ---
            const familySearch = document.getElementById('family-search');
            if (familySearch) { familySearch.addEventListener('input', updateFamilyProgressTable); }
            
            const progressFilter = document.getElementById('progress-filter');
            if (progressFilter) { progressFilter.addEventListener('change', updateFamilyProgressTable); }
            
            // ... existing listeners ...
            const eventStatusFilter = document.getElementById('event-status-filter');
            if(eventStatusFilter) {
                eventStatusFilter.addEventListener('change', e => {
                    const eventId = e.target.value;
                    const display = document.getElementById('event-status-display');
                    if (eventId === 'all') { display.innerHTML = '<p class="text-slate-500">Select an event from the dropdown to see its status.</p>'; return; }
                    const stats = adminData.eventStats[eventId];
                    if (stats) {
                        const hoursProgress = stats.hoursRequired > 0 ? (stats.hoursFilled / stats.hoursRequired) * 100 : 0;
                        const volunteerProgress = stats.totalNeeded > 0 ? (stats.totalSignedUp / stats.totalNeeded) * 100 : 0;
                        display.innerHTML = `<div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6"><div><h4 class="font-semibold text-slate-700">Volunteer Spots</h4><p class="text-lg">${stats.totalSignedUp} / ${stats.totalNeeded} Filled</p><div class="w-full bg-slate-200 rounded-full h-2.5 mt-2"><div class="bg-teal-600 h-2.5 rounded-full" style="width: ${volunteerProgress}%"></div></div></div><div><h4 class="font-semibold text-slate-700">Volunteer Hours</h4><p class="text-lg">${stats.hoursFilled} / ${stats.hoursRequired} Hours Filled</p><div class="w-full bg-slate-200 rounded-full h-2.5 mt-2"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${hoursProgress}%"></div></div></div></div>`;
                    }
                });
            }
            const volEventFilter = document.getElementById('volunteering-event-filter');
            if (volEventFilter) { volEventFilter.addEventListener('change', applyVolunteerFilters); }
            document.getElementById('hours-slider-s1')?.addEventListener('input', updateRemainingFamiliesCount);
            document.getElementById('hours-slider-s2')?.addEventListener('input', updateRemainingFamiliesCount);
        }

        window.onload = function() {
            try {
                google.accounts.id.initialize({ client_id: CLIENT_ID, callback: handleCredentialResponse });
                google.accounts.id.renderButton(document.getElementById('google-signin-button-container'), { theme: "outline", size: "large", width: "300" });
                google.accounts.id.prompt();
            } catch (error) {
                console.error("Google Sign-In initialization failed:", error);
                document.getElementById('login-screen').innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow-lg text-red-600"><p>Could not initialize Google Sign-In.</p></div>`;
            }
        };
    </script>
</body>
</html>
